# nsjail base configuration for code execution sandboxing
#
# This file documents the default sandbox policy used by LibreCodeInterpreter.
# Runtime configuration is generated programmatically by
# src/services/sandbox/nsjail.py via CLI arguments. This file serves as a
# reference for the security posture and can be used directly with nsjail
# for testing/debugging.

name: "code-interpreter-sandbox"
description: "Sandboxed code execution environment"

# Execute command once and exit
mode: ONCE

# ============================================
# Namespace isolation
# ============================================
clone_newuser: true
clone_newnet: true
clone_newns: true
clone_newpid: true
clone_newipc: true
clone_newuts: true
clone_newcgroup: true

# ============================================
# Resource limits
# ============================================

# Virtual memory limit (MB) — matches HARD rlimit
rlimit_as_type: HARD
rlimit_as: 512

# Max output file size (MB)
rlimit_fsize: 100

# Max number of open file descriptors
rlimit_nofile: 256

# Execution time limit (seconds)
time_limit: 30

# Max number of processes/threads
cgroup_pids_max: 64

# Memory cgroup limit (bytes) — 512 MB
cgroup_mem_max: 536870912

# ============================================
# Security settings
# ============================================

# Drop all capabilities
keep_caps: false

# Hostname visible inside sandbox
hostname: "sandbox"

# Disable /proc mount for security
disable_proc: true

# Run as non-root inside sandbox
uid_mapping {
    inside_id: "1001"
    outside_id: "1001"
    count: 1
}

gid_mapping {
    inside_id: "1001"
    outside_id: "1001"
    count: 1
}

# ============================================
# Filesystem mounts (read-only system paths)
# ============================================

# System binaries and libraries
mount {
    src: "/usr"
    dst: "/usr"
    is_bind: true
    rw: false
}

mount {
    src: "/lib"
    dst: "/lib"
    is_bind: true
    rw: false
}

mount {
    src: "/lib64"
    dst: "/lib64"
    is_bind: true
    rw: false
    mandatory: false
}

mount {
    src: "/bin"
    dst: "/bin"
    is_bind: true
    rw: false
}

mount {
    src: "/sbin"
    dst: "/sbin"
    is_bind: true
    rw: false
}

# SSL certificates
mount {
    src: "/etc/ssl"
    dst: "/etc/ssl"
    is_bind: true
    rw: false
    mandatory: false
}

mount {
    src: "/etc/alternatives"
    dst: "/etc/alternatives"
    is_bind: true
    rw: false
    mandatory: false
}

# Timezone data
mount {
    src: "/usr/share/zoneinfo"
    dst: "/usr/share/zoneinfo"
    is_bind: true
    rw: false
    mandatory: false
}

# Language-specific paths (read-only)
# Go
mount {
    src: "/usr/local/go"
    dst: "/usr/local/go"
    is_bind: true
    rw: false
    mandatory: false
}

# Rust/Cargo
mount {
    src: "/usr/local/cargo"
    dst: "/usr/local/cargo"
    is_bind: true
    rw: false
    mandatory: false
}

mount {
    src: "/usr/local/rustup"
    dst: "/usr/local/rustup"
    is_bind: true
    rw: false
    mandatory: false
}

# Go module cache
mount {
    src: "/usr/local/gopath"
    dst: "/usr/local/gopath"
    is_bind: true
    rw: false
    mandatory: false
}

# Java libraries
mount {
    src: "/opt/java"
    dst: "/opt/java"
    is_bind: true
    rw: false
    mandatory: false
}

# PHP Composer packages
mount {
    src: "/opt/composer"
    dst: "/opt/composer"
    is_bind: true
    rw: false
    mandatory: false
}

# Node.js global modules
mount {
    src: "/usr/local/lib/node_modules"
    dst: "/usr/local/lib/node_modules"
    is_bind: true
    rw: false
    mandatory: false
}

# REPL server
mount {
    src: "/opt/repl_server.py"
    dst: "/opt/repl_server.py"
    is_bind: true
    rw: false
    mandatory: false
}

# Writable tmpfs for temporary files
mount {
    dst: "/tmp"
    fstype: "tmpfs"
    rw: true
    options: "size=104857600"
}

# Working directory — bound at runtime to the sandbox data dir
# mount {
#     src: "<sandbox_data_dir>"
#     dst: "/mnt/data"
#     is_bind: true
#     rw: true
# }

# Default working directory
cwd: "/mnt/data"
